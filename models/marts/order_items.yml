models:
  - name: order_items
    description: Order items fact table containing individual food and drink items that make up each order. One row per order item.
    meta:
      sst:
        cortex_searchable: false
        synonyms:
          - order details
          - items in each order
          - order line items
          - order product information
        primary_key: order_item_id

    columns:
      - name: order_item_id
        description: The unique identifier for each order item.
        data_tests:
          - not_null
          - unique
        meta:
          sst:
            column_type: dimension
            data_type: TEXT
            synonyms:
              - order item identifier
              - item unique ID
              - order item code
              - item ID
            sample_values:
              - 099a05af-77d4-41c9-9bb0-e1a8e523fc03
              - 4c6a92fc-7b05-45a6-8049-1c15bbe0ece0
              - 6592c956-e725-4179-b8de-a8206c854d5b
              - db82aa13-357c-442e-8ec5-0c06f8973ae0
              - bf48059a-d0f7-4718-898d-d7bb0fc2ddfc
              - 561572ac-0132-4414-b04f-6975b16d8634
              - 61a7d9b8-cba1-4faf-9256-cfcd919f10b7
              - 18494180-8a44-4220-b728-77781721a71f
              - 697194fe-7ae4-4c54-925a-ac07bfb6de69
              - 8cb4b43a-d969-4d31-97ff-ca94b9d86ef7
            is_enum: false

      - name: order_id
        description: The identifier for the order this item belongs to.
        data_tests:
          - relationships:
              to: ref('orders')
              field: order_id

        meta:
          sst:
            column_type: dimension
            data_type: TEXT
            synonyms:
              - order identifier
              - order unique ID
              - order code
              - order number
            sample_values:
              - 6ce387d8-9846-459d-b67b-64d8af83e386
              - 26243a14-e416-4051-a0b2-c4d8349a1761
              - e0bebebb-b0e8-4177-b9a7-29bee5ca94f8
              - 44c30fea-d832-4607-93ab-b6548c82167a
              - 596be87e-49c9-4847-a5e6-8c113dc6db0e
              - 9e9b1155-36e8-499c-b5b6-727fa7ddb860
              - cb078923-bd30-4636-b1a7-d5c0704d4ef9
              - 01949c92-0a07-4940-9748-7f68652cce57
              - 37dd0273-da96-41e8-8d73-5ed5e56c382a
              - c85d35e1-369e-4dd3-8282-013468032a74
            is_enum: false

      - name: product_id
        description: The identifier for the product in this order item.
        meta:
          sst:
            column_type: dimension
            data_type: TEXT
            synonyms:
              - product identifier
              - product unique ID
              - product code
              - item code
            sample_values:
              - BEV-002
              - JAF-002
              - BEV-004
              - JAF-004
              - JAF-001
              - JAF-005
              - JAF-003
              - BEV-005
              - BEV-001
              - BEV-003
            is_enum: true

      - name: ordered_at
        description: The timestamp when the order containing this item was placed.
        meta:
          sst:
            column_type: time_dimension
            data_type: TIMESTAMP_NTZ
            synonyms:
              - order timestamp
              - order date and time
              - order time
              - order date
            sample_values:
              - '2024-12-13 00:00:00'
              - '2025-07-05 00:00:00'
              - '2024-09-08 00:00:00'
              - '2025-01-08 00:00:00'
              - '2025-03-31 00:00:00'
              - '2025-04-14 00:00:00'
              - '2024-10-27 00:00:00'
              - '2025-04-17 00:00:00'
              - '2025-04-18 00:00:00'
              - '2025-07-12 00:00:00'
            is_enum: false

      - name: product_name
        description: The name of the product in this order item.
        meta:
          sst:
            column_type: dimension
            data_type: TEXT
            synonyms:
              - product name
              - item name
              - product title
              - item title
            sample_values:
              - doctor stew
              - nutellaphone who dis?
              - mel-bun
              - flame impala
              - the krautback
              - 'for richer or pourover '
              - tangaroo
              - adele-ade
              - vanilla ice
              - chai and mighty
            is_enum: true

      - name: product_price
        description: The price of the product in this order item in dollars.
        meta:
          sst:
            column_type: fact
            data_type: NUMBER
            synonyms:
              - product price
              - item cost
              - product amount
              - item price
            sample_values:
              - '11.0'
              - '4.0'
              - '14.0'
              - '12.0'
              - '5.0'
              - '7.0'
              - '6.0'
            is_enum: false

      - name: is_food_item
        description: Boolean flag indicating whether this order item is a food item.
        meta:
          sst:
            column_type: dimension
            data_type: BOOLEAN
            synonyms:
              - food item flag
              - is food
              - food indicator
              - food status
            sample_values:
              - 'True'
              - 'False'
            is_enum: true

      - name: is_drink_item
        description: Boolean flag indicating whether this order item is a drink item.
        meta:
          sst:
            column_type: dimension
            data_type: BOOLEAN
            synonyms:
              - drink item flag
              - is drink
              - drink indicator
              - drink status
            sample_values:
              - 'False'
              - 'True'
            is_enum: true

      - name: supply_cost
        description: The cost of supplies needed to fulfill this order item in dollars.
        meta:
          sst:
            column_type: fact
            data_type: NUMBER
            synonyms:
              - supply cost
              - cost of supply
              - supply price
              - supply amount
            sample_values:
              - '0.82'
              - '2.51'
              - '1.21'
              - '1.54'
              - '3.43'
              - '3.66'
              - '0.63'
              - '1.75'
              - '2.39'
            is_enum: false
unit_tests:
  - name: test_supply_costs_sum_correctly
    description: "Test that the counts of drinks and food orders convert to booleans properly."
    model: order_items
    given:
      - input: ref('stg_supplies')
        rows:
          - {product_id: 1, supply_cost: 4.50}
          - {product_id: 2, supply_cost: 3.50}
          - {product_id: 2, supply_cost: 5.00}
      - input: ref('stg_products')
        rows:
          - {product_id: 1}
          - {product_id: 2}
      - input: ref('stg_order_items')
        rows:
          - {order_id: 1, product_id: 1}
          - {order_id: 2, product_id: 2}
          - {order_id: 2, product_id: 2}
      - input: ref('stg_orders')
        rows:
          - {order_id: 1}
          - {order_id: 2}
    expect:
      rows:
        - {order_id: 1, product_id: 1, supply_cost: 4.50}
        - {order_id: 2, product_id: 2, supply_cost: 8.50}
        - {order_id: 2, product_id: 2, supply_cost: 8.50}

semantic_models:
  - name: order_item
    defaults:
      agg_time_dimension: ordered_at
    description: |
      Items contatined in each order. The grain of the table is one row per order item.
    model: ref('order_items')
    entities:
      - name: order_item
        type: primary
        expr: order_item_id
      - name: order_id
        type: foreign
        expr: order_id
      - name: product
        type: foreign
        expr: product_id
    dimensions:
      - name: ordered_at
        expr: ordered_at
        type: time
        type_params:
          time_granularity: day
      - name: is_food_item
        type: categorical
      - name: is_drink_item
        type: categorical
    measures:
      - name: revenue
        description: The revenue generated for each order item. Revenue is calculated as a sum of revenue associated with each product in an order.
        agg: sum
        expr: product_price
      - name: food_revenue
        description: The revenue generated for each order item. Revenue is calculated as a sum of revenue associated with each product in an order.
        agg: sum
        expr: case when is_food_item then product_price else 0 end
      - name: drink_revenue
        description: The revenue generated for each order item. Revenue is calculated as a sum of revenue associated with each product in an order.
        agg: sum
        expr: case when is_drink_item then product_price else 0 end
      - name: median_revenue
        description: The median revenue generated for each order item.
        agg: median
        expr: product_price

metrics:
  # Simple metrics
  - name: revenue
    description: Sum of the product revenue for each order item. Excludes tax.
    type: simple
    label: Revenue
    type_params:
      measure: revenue
  - name: order_cost
    description: Sum of cost for each order item.
    label: Order Cost
    type: simple
    type_params:
      measure: order_cost
  - name: median_revenue
    description: The median revenue for each order item. Excludes tax.
    type: simple
    label: Median Revenue
    type_params:
      measure: median_revenue
  - name: food_revenue
    description: The revenue from food in each order
    label: Food Revenue
    type: simple
    type_params:
      measure: food_revenue
  - name: drink_revenue
    description: The revenue from drinks in each order
    label: Drink Revenue
    type: simple
    type_params:
      measure: drink_revenue

  # Ratio Metrics
  - name: food_revenue_pct
    description: The % of order revenue from food.
    label: Food Revenue %
    type: ratio
    type_params:
      numerator: food_revenue
      denominator: revenue
  - name: drink_revenue_pct
    description: The % of order revenue from drinks.
    label: Drink Revenue %
    type: ratio
    type_params:
      numerator: drink_revenue
      denominator: revenue

  # Derived Metrics
  - name: revenue_growth_mom
    description: "Percentage growth of revenue compared to 1 month ago. Excluded tax"
    type: derived
    label: Revenue Growth % M/M
    type_params:
      expr: (current_revenue - revenue_prev_month)*100/revenue_prev_month
      metrics:
        - name: revenue
          alias: current_revenue
        - name: revenue
          offset_window: 1 month
          alias: revenue_prev_month
  - name: order_gross_profit
    description: Gross profit from each order.
    type: derived
    label: Order Gross Profit
    type_params:
      expr: revenue - cost
      metrics:
        - name: revenue
        - name: order_cost
          alias: cost

  #Cumulative Metrics
  - name: cumulative_revenue
    description: The cumulative revenue for all orders.
    label: Cumulative Revenue (All Time)
    type: cumulative
    type_params:
      measure: revenue

saved_queries:
  - name: revenue_metrics
    query_params:
      metrics:
        - revenue
        - food_revenue
        - drink_revenue
      group_by:
        - TimeDimension('metric_time', 'day')
    exports:
      - name: revenue_metrics
        config:
          export_as: table
